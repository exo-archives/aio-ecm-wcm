<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title> eXo File Explorer</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="eXpires" content="0">
		<link type="text/css" rel="stylesheet" href="css/explorer.css">
		<link type="text/css" rel="stylesheet" href="../../../../ecm/skin/icons/16x16/NodeTypes/DefaultStylesheet.css">
		<script type="text/javascript" src="js/explorer.js"></script>
		<script type="text/javascript" src="js/kombai.js"></script>
		<script type="text/javascript">
			var eXoPlugin = window.opener.eXoPlugin;
			eXoPlugin.userLanguage = "vi";
			eXoPlugin.loadScript(window, "lang/" + eXoPlugin.userLanguage + ".js");
		</script>
	</head>
	<body onclick="hideContextMenu();" oncontextmenu="javascript: return false;" scroll="no">
		<div id="root" class="Root" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
		<div id="Explorer" class="Explorer">
			<div class="FolderNavigation">
				<div class="TitleBar">
					<div class="TitleText" userLanguage="KLang.TreeTitle">
						Folders
					</div>
				</div>
				<div class="Tree"></div>
			</div>
			
			<div class="FolderSeparator"><span></span></div>
			
			<div class="FolderExplorer">
				<div class="MenuBar">
					<a href="javascript: void(0)">
						<div class="Item IconRefresh" style="display: none" userLanguage="KLang.BtnRefresh">Refresh</div>
					</a>
					<a href="javascript: void(0)" onclick="showUploadForm(this.id, true)">
						<div class="Item IconUpload" userLanguage="KLang.BtnUpload">Upload File</div>
					</a>
					<img src="images/IconSeparator2x26.gif" class="IconSeparator" style="display: none">
					<a href="javascript: void(0)" onclick="showSetting('Setting')">
						<div class="Item IconSetting" userLanguage="KLang.BtnSetting">Setting</div>
					</a>
					<a href="javascript: void(0)">
						<div class="Item IconHelp" style="display: none" userLanguage="KLang.BtnHelp">Help</div>
					</a>
					<div style="clear: left;"><span></span></div>
				</div>
				<div class="Setting" style="display: none;">
					<div class="TitleBar" userLanguage="KLang.SettingTitle">Settings</div>
					<div class="SettingDiv">
						<table class="SettingTable" align="center" cellpadding="0" cellspacing="0">
							<tr>
								<td userLanguage="KLang.SetView">View: </td>
								<td userLanguage="KLang.SetSort">Sorting: </td>
							</tr>
							<tr>
							    <td><input type="radio" name="View"><span userLanguage="KLang.ViewThumbnail">Thumbnails</span></td>
								<td><input type="radio" onclick="sort('name')" name="Sort"><span userLanguage="KLang.SortName">By File Name</span></td>
		                    </tr>
							<tr>
							    <td><input type="radio" name="View"><span userLanguage="KLang.ViewList">List</span></td>
								<td><input type="radio" onclick="sort('date')" name="Sort"><span userLanguage="KLang.SortDate">By Date</span></td>
		                    </tr>
							<tr>
							    <td/>
								<td><input type="radio" onclick="sort('size')" name="Sort"><span userLanguage="KLang.Sort_Size">By Size</span></td>
		                    </tr>
						</table>
						<table align="center">
							<tr>
								<td align="center">
									<a href="javascript: void(0)" onclick="showSetting('Setting')">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnClose">
													Close
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<div class="DocumentDiv"><span></span></div>	
			</div>
		</div>
			
		<div id="StatusBar" class="StatusBar">
			<span class="Folder"></span>
			<span class="Item"></span>
		</div>
		
		<div id="HideContainer" class="HideContainer" style="width: 0; height: 0; display: none">
			<div class="HideTreeRoot">
				<div id="/Document" class="HomeNode">
					<span>&nbsp;</span>
				</div>
				<div id="/Document/group/" class="NodeGroup"></div>
			</div>
			<div class="HideTreeNode">
				<div class="Node ${sClass}" style="display: block">
					<div class="IconExpand">
						<div id="${sCurrentFolder}${sName}/" class="${sType} IconNode IconClose default16x16Icon" onclick="getDir('getFoldersAndFiles', '${sCurrentFolder}${sName}'); openTree(this); changeUploadForm(this.id)" oncontextmenu="showContextMenu('AddNewDocument', event, this)">
							<a href="javascript: void(0)">
								${sName}
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="HideTreeItem">
				<table class="DocumentTable" align="center" cellpadding="4">
					<tr>
						<td class="ItemName ${sType}">
							<a id="${sURL}" href="javascript: void(0)" oncontextmenu="showContextMenu('ListItemOption', event, this)">${sName}</a>
						</td>
						<td class="ItemDate">${sDateCreated}</td>
						<td class="ItemSize">${sSize} kB</td>
					</tr>
				</table>
			</div>
			<div class="HideAddForm">
				<div class="AddForm">
					${idShort}
					<p><input id="${idTxt}" type="text"></p>
					<p>
						<table align="center">
							<tr>
								<td align="center">
									<a href="javascript: void(0)" onclick="doAddForm('${idOrig}',document.getElementById('${idTxt}').value)">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnCreate">
													Create
												</div>
											</div>
										</div>
									</a>
								</td>
								<td align="center">
									<a href="javascript: void(0)" onclick="showAddForm('${id}', false)">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnCancel">
													Cancel
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
					</p>
				</div>
			</div>
			<div class="HideMask">
				<div class="Mask"></div>
			</div>
			<div class="HideIFrameForm">
				<iframe class="IFrameForm">
				</iframe>
			</div>
			<div class="HideUploadForm">
				<div class="UploadForm"> 
					<form id="UploadForm">
						${idShort}
						<p><input type="file" id="${id}-file"></p>
						<p>
							<table align="center">
								<tr>
									<td align="center">
										<a href="javascript: void(0)" onclick="document.getElementById('UploadForm').submit()">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" userLanguage="KLang.BtnUpload">
														Upload
													</div>
												</div>
											</div>
										</a>
									</td>
									<td align="center">
										<a href="javascript: void(0)" onclick="showAddForm('${id}', false)">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" userLanguage="KLang.BtnCancel">
														Cancel
													</div>
												</div>
											</div>
										</a>
									</td>
								</tr>
							</table>
						</p>
					<form>
				</div>
			</div>
		</div>
		</div>
		<div id="Context" style="border: 1px solid red; position: absolute; top: 0px; left: 0px; width: 0px; height: 0px;">	
			<div class="ContextMenu AddNewDocument">
				<a href="javascript: void(0)" class="MenuItem"> 	
					<div class="IconItem IconAdd" onclick="showAddForm(this.id, true)" userLanguage="KLang.CtxNewDoc">
						Add New
					</div>
				</a>
			</div>
			<div class="ContextMenu ListItemOption">
				<a href="javascript: void(0)" class="MenuItem"> 	
					<div class="IconItem IconView" onclick="window.open(this.id.replace('-view',''),'','width=350,height=250')" userLanguage="KLang.CtxViewItem">
						View
					</div>
				</a>
				<a href="javascript: void(0)" class="MenuItem"> 	
					<div class="IconItem IconSelect" onclick="alert(this.id.replace('-select',''))" userLanguage="KLang.CtxSelectItem">
						Select
					</div>
				</a>
			</div>
		</div>
	</body>

	<script type="text/javascript">

	var eXp = {
		connector: eXoPlugin.eXoFileManager.Connector,
		resourceType: eXoPlugin.eXoFileManager.ResourceType,
		command: {
			init: "getFoldersAndFiles",
			getFiles: "getFiles",
			uploadFile: "uploadFile",
			getFolders: "getFolders",
			createFolder: "createFolder"
		},
		buildParam: function() {
			if (arguments.length < 1) return null;
			var arr = [];
			for (var i = 0; i < arguments.length; ++i) {
				arr.push(arguments[i]);
			}
			return arr.join("&");
		},
		getNodes: function(DomX, nodeName) {
			if (!DomX || !nodeName) return null;
			var node = DomX.getElementsByTagName(nodeName);
			if (node.length) return node;
			else return null;
		},
		getSingleNode: function(DomX, nodeName) {
			var nodes = this.getNodes(DomX, nodeName);
			if (nodes[0]) return nodes[0];
			else return null;
		},
		getNodeValue: function(node, name) {
			return node.attributes.getNamedItem(name).value;
		},
		sendRequest: function(connector, param, callback)  {
			K.request({
				address: connector,
				data: param,
				method: "GET",
				onSuccess: function() {
				if (callback && callback instanceof Function) {
						if (this.responseXML) {
							var response = this.responseXML;
							
							callback(response);
						}
						else {
							callback(this.responseText);
						}
					}
				},
				onFailure: function() {
					alert('Can\'t connect to sever. Please try again.');
				}
			});
		}
	}
	
	function requestInit() {
		var connector = eXoPlugin.hostName + eXp.connector + eXp.command.init;
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=/", "CurrentPortal=" + eXoPlugin.portalName);
		eXp.sendRequest(connector, param, treeInit);
	}

	function languageInit() {
		//change language
		if (KLang) {
			var aElements = document.getElementsByTagName("*");
			for (var i = 0 ; i < aElements.length; ++i) {
				if (aElements[i].getAttribute && aElements[i].getAttribute("userLanguage")) {
					var userLanguage = eval(aElements[i].getAttribute("userLanguage"));
					var textNode = document.createTextNode(userLanguage);
					aElements[i].innerHTML = "";
					aElements[i].appendChild(textNode);
				}
			}
		}
	};
	
	var oExplorer = document.getElementById('Explorer');
	var oTree = getElementsByClassPath(oExplorer, 'FolderNavigation/Tree')[0];
	var oFExplorer = getElementsByClassPath(oExplorer, 'FolderExplorer')[0];
	var oDocument = getElementsByClassPath(oExplorer, 'FolderExplorer/DocumentDiv')[0];
	var oSetting = getElementsByClassPath(oExplorer, 'FolderExplorer/Setting')[0];
	
	var oStatus = document.getElementById('StatusBar');
	var oStatusFolder = getElementsByClassPath(oStatus, 'Folder')[0];
	var oStatusFile = getElementsByClassPath(oStatus, 'Item')[0];
	
	var oHide = document.getElementById('HideContainer');
	var oHideTreeRoot = getElementsByClassPath(oHide, 'HideTreeRoot')[0];
	var oHideMask = getElementsByClassPath(oHide, 'HideMask')[0];
	var oHideIFrame = getElementsByClassPath(oHide, 'HideIFrameForm')[0];
	
	var oBody = document.body;
	
	var DB = {};
	
	function elementResize() {
		// Height of 'FolderNavigationTitleBar': 22px;
		// Border of 'FolderNavigationTitleBar': 1px;
		// Height of 'FolderExplorerStatusBar': 20px;
		// Total: 53px;
		//return;
		oExplorer.style.height = document.documentElement.clientHeight - 20 + 'px';
		oTree.style.height = document.documentElement.clientHeight - 53 + 'px';
		if (oSetting.style.display == 'none') {
			oDocument.style.height = document.documentElement.clientHeight - 59 + 'px';
		}
		else {
			oDocument.style.height = document.documentElement.clientHeight - 225 + 'px';
			alert(oSetting.offsetHeight)
		}
	}
	
	K.addEventOnLoad(languageInit);
	K.addEventOnLoad(requestInit);
	K.addEventOnLoad(elementResize);
	K.addEventOnResize(elementResize);

	function getDir(action, name) {
		var connector = eXoPlugin.hostName + eXp.connector + action;
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=" + name + "/", "CurrentPortal=" + eXoPlugin.portalName);
		eXp.sendRequest(connector, param, treeGen);
	}
	
	function treeInit(sXML) {
		oTree.innerHTML += oHideTreeRoot.innerHTML;
		
		var sHTML = '';
		
		// Folder generator
		var oFolders = eXp.getNodes(sXML, "Folder");
		if (oFolders != null) {
			var iLength = oFolders.length;
			for (var i = 0 ; i < iLength; i++) {
				var sName = eXp.getNodeValue(oFolders[i], "name");
				var sType = eXp.getNodeValue(oFolders[i], "folderType").replace(':','_') + '16x16Icon';
				var sHideTreeNode = getElementsByClassPath(oHide, 'HideTreeNode')[0].innerHTML;
				if (i == iLength - 1) sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, 'LastNode');
				else sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, '');
				sHideTreeNode = sHideTreeNode.replace(/\${sName}/g, sName);
				sHideTreeNode = sHideTreeNode.replace(/\${sType}/g, sType);
				sHideTreeNode = sHideTreeNode.replace(/\${sCurrentFolder}/g, '/');
				sHideTreeNode = sHideTreeNode.replace('oncontextmenu="showContextMenu(\'AddNewDocument\', event, this)"','');
				sHTML += sHideTreeNode;
			}
			oStatusFolder.innerHTML = iLength + ' folder(s)';
		} else {
			oStatusFolder.innerHTML = '0 folder(s)';
		}
		document.getElementById('/Document/group/').innerHTML = sHTML;
	}
	
	function treeGen(sXML) {
		
		var sHTML = '';
		
		var sCurrentFolder = eXp.getNodeValue(eXp.getSingleNode(sXML, 'CurrentFolder'), 'path');
		var sCurrentFolderName = eXp.getNodeValue(eXp.getSingleNode(sXML, 'CurrentFolder'), 'name');
		
		sCurrentFolder = sCurrentFolder.replace('/Web Content/Live','');
		sCurrentFolder = sCurrentFolder.replace('/multimedia','')
		
		
		// Folder generator
		var oFolders = eXp.getNodes(sXML, "Folder");
		if (oFolders != null) {
			var iLength = oFolders.length;
			var oNodeGroup = document.getElementById(sCurrentFolder + 'group/');
			if (oNodeGroup == null) {
				sHTML += '<div id="' + sCurrentFolder + 'group/" class="NodeGroup">';
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFolders[i], "name");
					var sType = eXp.getNodeValue(oFolders[i], "folderType").replace(':', '_') + '16x16Icon';
					var sHideTreeNode = getElementsByClassPath(oHide, 'HideTreeNode')[0].innerHTML;
					if (i == iLength - 1) sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, 'LastNode');
					else sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, '');
					sHideTreeNode = sHideTreeNode.replace(/\${sName}/g, sName);
					sHideTreeNode = sHideTreeNode.replace(/\${sType}/g, sType);
					sHideTreeNode = sHideTreeNode.replace(/\${sCurrentFolder}/g, sCurrentFolder);
					sHTML += sHideTreeNode;
				}
				sHTML += '</div>'
			}
			getElementsByClassPath(document.getElementById('StatusBar'), 'Folder')[0].innerHTML = iLength + ' folder(s)';
			document.getElementById(sCurrentFolder).parentNode.innerHTML += sHTML;
		} else {
			getElementsByClassPath(document.getElementById('StatusBar'), 'Folder')[0].innerHTML = '0 folder(s)';
		}
		
		// Item generator
		sHTML = '';
		var oFiles = eXp.getNodes(sXML, "File");
		DB = K.create.database({fieldName: ["name", "date", "size", "type", "url"]});
		if (oFiles != null) {
			var oItemGroup = document.getElementById('checkgen');
			var iLength = oFiles.length;
			if (oItemGroup == null || oItemGroup == '') {
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sURL = eXoPlugin.hostName + '/' + eXp.getNodeValue(oFiles[i], "url");
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					var HideTreeItem = getElementsByClassPath(oHide, 'HideTreeItem')[0].innerHTML;
					HideTreeItem = HideTreeItem.replace(/\${sName}/g, sName);
					HideTreeItem = HideTreeItem.replace(/\${sType}/g, sType);
					HideTreeItem = HideTreeItem.replace(/\${sDateCreated}/g, sDateCreated.getDate() + '/' + sDateCreated.getMonth() + '/' + sDateCreated.getFullYear() + ' ' + sDateCreated.getHours() + ':' + sDateCreated.getMinutes());
					HideTreeItem = HideTreeItem.replace(/\${sURL}/g, sURL);
					HideTreeItem = HideTreeItem.replace(/\${sSize}/g, sSize);
					sHTML += '<input type="hidden" id="checkgen">'
					sHTML += HideTreeItem;
					DB.Insert([sName, sDateCreated, sSize, sType, sURL]);
				}
				oDocument.innerHTML += sHTML;
			} else {
				DB.Drop();
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					DB.Insert([sName, sDateCreated, sSize, sType]);
				} 
				sort('date');
			}
			oStatusFile.innerHTML = iLength + ' files((s)';
		} else {
			DB.Drop();
			oDocument.innerHTML = '';
			oStatusFile.innerHTML = '0 files((s)';
		}
	}
	
	function sort(sCondition) {
		oDocument.innerHTML = '';
		var sHTML = '';
		var aResult = DB.Select({orderBy: sCondition});
		var iLength = aResult.length;
		for (var i = 0; i < iLength; i++) {
			var HideTreeItem = getElementsByClassPath(oHide, 'HideTreeItem')[0].innerHTML;
			HideTreeItem = HideTreeItem.replace(/\${sName}/g, aResult[i].name);
			HideTreeItem = HideTreeItem.replace(/\${sType}/g, aResult[i].type);
			HideTreeItem = HideTreeItem.replace(/\${sDateCreated}/g, aResult[i].date.getDate() + '/' + aResult[i].date.getMonth() + '/' + aResult[i].date.getFullYear() + ' ' + aResult[i].date.getHours() + ':' + aResult[i].date.getMinutes());
			HideTreeItem = HideTreeItem.replace(/\${sURL}/g, aResult[i].url);
			HideTreeItem = HideTreeItem.replace(/\${sSize}/g,  aResult[i].size);
			sHTML += '<input type="hidden" id="checkgen">'
			sHTML += HideTreeItem;
		}
		oDocument.innerHTML += sHTML;
	}
	
	// Action is executed in: Right click Folder Explorer Navigator -> Choose Add new (bShow = true) or Right click Folder Explorer Navigator -> Choose Add new -> Click Create -> Click Cancel (bShow = false)
	function showAddForm(id, bShow) {
		var idOrig = id.replace('add/','');
		var sMaxLength = 23;
		var idShort = (idOrig == '/Document' ? '/' : (idOrig.length > sMaxLength ? ('... ' + idOrig.substring(idOrig.length - sMaxLength)) : idOrig))
		var idTxt = id.replace('add/','txt/');
		var sHideAddForm = getElementsByClassPath(oHide, 'HideAddForm')[0].innerHTML;
		sHideAddForm = sHideAddForm.replace(/\${idOrig}/g, idOrig);
		sHideAddForm = sHideAddForm.replace(/\${idShort}/g, idShort);
		sHideAddForm = sHideAddForm.replace(/\${idTxt}/g, idTxt);
		sHideAddForm = sHideAddForm.replace(/\${id}/g, id);
		
		//elementResize();
		if (bShow) {
			oBody.innerHTML += sHideAddForm;
			oBody.innerHTML += oHideMask.innerHTML;
		}
		else {
			oBody.innerHTML = oBody.innerHTML.replace(sHideAddForm, '');
			oBody.innerHTML = oBody.innerHTML.replace(oHideMask.innerHTML, '', 'g');
		}
	}
		
	// Action is executed in: Right click Folder Explorer Navigator -> Choose Add new -> Click Create
	function doAddForm(sCurrentFolder, sFolderName) {
		var connector = eXoPlugin.hostName + eXp.connector + 'createFolder';
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=" + (sCurrentFolder == '/Document' ? '' : sCurrentFolder), "NewFolderName=" + sFolderName, "CurrentPortal=" + eXoPlugin.portalName);
		eXp.sendRequest(connector, param, function(sXML) {
											var oNodes = eXp.getNodes(sXML, "Error")[0];
											var sErrorNumber = eXp.getNodeValue(oNodes, "number");
											var sErrorText = eXp.getNodeValue(oNodes, "text");
											if (sErrorNumber != '0') {
												alert(sErrorText);
											} else {
												showAddForm(sCurrentFolder + 'add/', false);
												// problem when current folder = / or  create 2 folder in same parent
												getDir('getFoldersAndFiles', sCurrentFolder.substring(0, sCurrentFolder.length-1));
											}
										});
	}
	
	function changeUploadForm(id) {
		var sMaxLength = 23;
		var idShort = (id == '/Document' ? '/' : (id.length > sMaxLength ? ('...' + id.substring(id.length - sMaxLength)) : id))
		var oHideUploadForm = getElementsByClassPath(oHide, 'HideUploadForm')[0];
		oHideUploadForm.innerHTML = oHideUploadForm.innerHTML.replace(/\${id}/g, id);
		oHideUploadForm.innerHTML = oHideUploadForm.innerHTML.replace(/\${idShort}/g, idShort);
	}
	
	function showUploadForm(id, bShow) {
		if (id == '') changeUploadForm('/Document');
		if (bShow) {
			var ohif = getElementsByClassPath(oHide, 'HideIFrameForm')[0];
			
			
			var oif = getElementsByClassPath(oHide, 'HideIFrameForm/IFrameForm')[0];
			/*
			var oifd = oif.contentWindow.document;
			
			
			oifd.open();
			oifd.write('<html>');
			oifd.write('<body>');
			oifd.write('<b>abcxyz</b>');
			oifd.write('</body>');
			oifd.write('</html>');
			oifd.close();
			*/
			//alert(oiff.innerHTML);
			//alert(ohif.innerHTML);
			
			oBody.innerHTML += ohif.innerHTML;
			//oBody.innerHTML += oHideMask.innerHTML;;
		} else {
			//oBody.innerHTML = oBody.innerHTML.replace(oif.body.innerHTML, '');
			//oBody.innerHTML = oBody.innerHTML.replace(oHideMask.innerHTML, '', 'g');
		}
	}
	</script>
</html>