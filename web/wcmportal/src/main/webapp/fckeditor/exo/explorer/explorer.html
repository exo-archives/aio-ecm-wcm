<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title> eXo File Explorer</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="eXpires" content="0">
		<link type="text/css" rel="stylesheet" href="css/explorer.css">
		<link type="text/css" rel="stylesheet" href="../../../../ecm/skin/icons/16x16/NodeTypes/DefaultStylesheet.css">
		<script type="text/javascript" src="js/explorer.js"></script>
		<script type="text/javascript" src="js/kombai.js"></script>
		<script type="text/javascript">
			var FCKConfig = window.opener.FCKConfig;
			var eXoPlugin = window.opener.eXoPlugin;
			var oEditor = window.opener.FCK;
			eXoPlugin.loadScript(window, "lang/" + eXoPlugin.userLanguage + ".js");
		</script>
	</head>
	<body onclick="hideContextMenu();" oncontextmenu="return false;" scroll="no">
		<div id="root" class="Root" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
			<div id="explorer" class="Explorer">
				<div class="Navigation">
					<div class="MenuBar" userLanguage="KLang.TreeTitle">
						Folders
					</div>
					<div class="Tree">
						<div class="HomeNode">
							<span style="display: none;"></span>
						</div>
						<div class="NodeGroup" style="margin-left: -20px;"></div>
					</div>
				</div>
				<div class="Separator"><span></span></div>
				<div class="Workspace">
					<div class="MenuBar">
						<a href="javascript: void(0);" onclick="showUploadForm(true)">
							<div class="Item IconUpload" userLanguage="KLang.BtnUpload">Upload File</div>
						</a>
						<img src="images/IconSeparator2x26.gif" class="IconSeparator" style="display: none;">
						<a href="javascript: void(0);" onclick="showSetting()">
							<div class="Item IconSetting" userLanguage="KLang.BtnSetting">Setting</div>
						</a>
						<div style="clear: left;"><span style="display: none;"></span></div>
					</div>
					<div class="Setting" style="display: none;">
						<div class="TitleBar" userLanguage="KLang.SettingTitle">Settings</div>
						<div class="SettingArea">
							<table class="SettingTable" align="center" cellpadding="0" cellspacing="0">
								<tr>
									<td userLanguage="KLang.SetView">View: </td>
									<td userLanguage="KLang.SetSort">Sorting: </td>
								</tr>
								<tr>
								    <td><input type="radio" name="View"><span userLanguage="KLang.ViewThumbnail">Thumbnails</span></td>
									<td><input type="radio" onclick="sort('name')" name="Sort"><span userLanguage="KLang.SortName">By File Name</span></td>
			                    </tr>
								<tr>
								    <td><input type="radio" name="View"><span userLanguage="KLang.ViewList">List</span></td>
									<td><input type="radio" onclick="sort('date')" name="Sort"><span userLanguage="KLang.SortDate">By Date</span></td>
			                    </tr>
								<tr>
								    <td/>
									<td><input type="radio" onclick="sort('size')" name="Sort"><span userLanguage="KLang.Sort_Size">By Size</span></td>
			                    </tr>
							</table>
							<table align="center">
								<tr>
									<td align="center">
										<a href="javascript: void(0);" onclick="showSetting()">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" userLanguage="KLang.BtnClose">
														Close
													</div>
												</div>
											</div>
										</a>
									</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="DisplayArea"><span></span></div>	
				</div>
			</div>
				
			<div id="statusBar" class="StatusBar">
				<span class="Folder"></span>
				<span class="Item"></span>
			</div>
			
			<div id="hideContainer" class="HideContainer" style="display: none;">
				<div class="TreeNode">
					<div class="Node ${sClass}">
						<div class="Collapse" onclick="openTree(this);">
							<div class="IconNode ${sType}" title="${sCurrentFolder}${sName}/" onclick="getDir(this);" oncontextmenu="showContextMenu('AddNewDocument', event, this)">
								<a href="javascript: void(0);">
									${sName}
								</a>
							</div>
						</div>
						<div class="NodeGroup"></div>
					</div>
				</div>
				<div class="HideTreeItem">
					<table class="DocumentTable" align="center" cellpadding="4">
						<tr>
							<td class="ItemName ${sType}">
								<a id="${sURL}" href="javascript: void(0);" oncontextmenu="showContextMenu('ListItemOption', event, this)">${sName}</a>
							</td>
							<td class="ItemDate">${sDateCreated}</td>
							<td class="ItemSize">${sSize} kB</td>
						</tr>
					</table>
				</div>
				
				<div class="AddFormContainer" style="display: none;">
					<div class="AddForm">
						<div>Folder: ${idShort}</div>
						New folder : <input name="fileName" type="text">
						<input name="hidden" type="hidden" value="${idShort}">
						<table align="center">
							<tr>
								<td align="center">
									<a href="javascript: void(0);">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" onclick="doAddForm()" userLanguage="KLang.BtnCreate">
													Create
												</div>
											</div>
										</div>
									</a>
								</td>
								<td align="center">
									<a href="javascript: void(0);">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" onclick="K('Mask').onclick(event);" userLanguage="KLang.BtnCancel">
													Cancel
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
					</div>
				</div>


				<div id="UploadContainer" style="display: none;">
					<form class="UploadForm" style="overflow: auto;" target="iFrameUpload" enctype="multipart/form-data" method="post">
						<table height="150px;">
							<tr>
								<td>
									Folder: ${idShort}
								</td>
							</tr>							
							<tr class="UploadInfo">
								<td >
									<div class="UploadProgress"></div>
									<a href="javascript: void(0);">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" onclick="uploadFile.Abort()">
													Abort
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
							<tr class="UploadAction">
								<td>
									Name: <br>
									<input type="text" name="fileName" style="float: none; width: 99%;" maxlength="128"><br>
									<div>
										<a href="javascript: void(0);">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" onclick="uploadFile.Cancel()">
														Cancel
													</div>
												</div>
											</div>
										</a>
										<a href="javascript: void(0);">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" onclick="uploadFile.Delete()">
														Delete
													</div>
												</div>
											</div>
										</a>
										<a href="javascript: void(0);">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" onclick="uploadFile.Save()">
														Save
													</div>
												</div>
											</div>
										</a>
										<div style="clear: left;"><span style="display: none;"></span></div>
									</div>	
								</td>
							</tr>
							<tr class="UploadField">
								<td>
									<input type="file" name="file">
									<a href="javascript: void(0);">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnUpload" onclick="uploadFile()">
													Upload
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
						<iframe name="iFrameUpload" id="iFrameUpload" frameborder="0px" border="0px"></iframe>
					<form>
				</div>
			</div>
		</div>
		<div id="contextMenu" style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px;">	
			<div class="ContextMenu AddNewDocument">
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconAdd" onclick="showAddForm(event, this)" userLanguage="KLang.CtxNewDoc">
						Add New
					</div>
				</a>
			</div>
			<div class="ContextMenu ListItemOption">
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconView" onclick="window.open(this.id.replace('/view/',''),'','width=350, height=250')" userLanguage="KLang.CtxViewItem">
						View
					</div>
				</a>
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconSelect" onclick="alert(this.id.replace('/select/',''))" userLanguage="KLang.CtxSelectItem">
						Select
					</div>
				</a>
			</div>
		</div>
		<div class="Mask" id="Mask"></div>
		<div class="PopupContainer"  id="PopupContainer">
		</div>
	</body>

	<script type="text/javascript">
	
	
	function getUrlParam(paramName) {
		var oRegex = new RegExp("[\?&]" + paramName + "=([^&]+)", "i");
		var oMatch = oRegex.exec(window.location.search) ; 
		if (oMatch && oMatch.length > 1) return oMatch[1];
		else return "";
	}
	var eXp = {
		resourceType: getUrlParam("Type") || eXoPlugin.eXoFileManager.ResourceType,
		connector: getUrlParam("Connector") || eXoPlugin.eXoFileManager.Connector,
		command: {
			init: "getFoldersAndFiles",
			uploadFile: "uploadFile/upload",
			controlUpload: "uploadFile/control",
			createFolder: "createFolder"
		},
		store: {
			currentNode: {},
			currentFolder: "/",
			data: {}
		},
		buildParam: function() {
			if (arguments.length < 1) return null;
			var arr = [];
			for (var i = 0; i < arguments.length; ++i) {
				arr.push(arguments[i]);
			}
			arr.push("language=" + eXoPlugin.userLanguage);
			return arr.join("&");
		},
		getNodes: function(DomX, nodeName) {
			if (!DomX || !nodeName) return null;
			var node = DomX.getElementsByTagName(nodeName);
			if (node.length) return node;
			else return null;
		},
		getSingleNode: function(DomX, nodeName) {
			var nodes = this.getNodes(DomX, nodeName);
			if (nodes[0]) return nodes[0];
			else return null;
		},
		getNodeValue: function(node, name) {
			return node.attributes.getNamedItem(name).value;
		},
		getID: function() {
			return Math.random().toString().substring(2);
		},
		sendRequest: function(connector, param, callback)  {
			K.request({
				address: connector,
				data: param,
				method: "GET",
				onSuccess: function() {
				if (K.check.isFunction(callback)) {
						if (this.responseXML) {
							var response = this.responseXML;
							callback(response);
						} else {
							callback(this.responseText);
						}
					}
				},
				onFailure: function() {
					alert('Can\'t connect to sever. Please try again.');
				}
			});
		}
	}
	
	var curLength = 0;
	var curUploadId = 0;
	
	function buildXParam() {
		var repositoryName = FCKConfig.repositoryName;
		var workspaceName = FCKConfig.workspaceName;
		var jcrPath = FCKConfig.jcrPath;
		var param = '';
		if (repositoryName !== undefined) param += 'repositoryName=' + repositoryName;
		if (workspaceName !== undefined) param += '&workspaceName=' + workspaceName;
		if (jcrPath === undefined) jcrPath = '';
		param += "&jcrPath=" + jcrPath;
		return param;
	}
	
	function requestInit() {
		var connector = eXoPlugin.hostName + eXp.connector + eXp.command.init;
		var param = eXp.buildParam(
					"type=" + eXp.resourceType,
					"currentFolder=/",
					"currentPortal=" + eXoPlugin.portalName,
					buildXParam()
				);
		eXp.sendRequest(connector, param, treeInit);
	}

	function languageInit() {
		if (KLang) {
			var aElements = document.getElementsByTagName("*");
			for (var i = 0 ; i < aElements.length; ++i) {
				if (aElements[i].getAttribute && aElements[i].getAttribute("userLanguage")) {
					var userLanguage = eval(aElements[i].getAttribute("userLanguage"));
					var textNode = document.createTextNode(userLanguage);
					aElements[i].innerHTML = "";
					aElements[i].appendChild(textNode);
				}
			}
		} else {
			eXoPlugin.loadScript(window, "lang/en.js");
			setTimeout(languageInit, 2000);
		}
	};
	

	function elementResize() {
		var oExplorer = K("explorer");
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oStatus = K('statusBar');
		oExplorer.style.height = K.get.windowHeight() - oStatus.offsetHeight + 'px';

		var oTreeTitle = getElementsByClassPath(oExplorer, 'Navigation/MenuBar')[0];
		var oTree = getElementsByClassPath(oExplorer, 'Navigation/Tree')[0];
		oTree.style.height = K.get.windowHeight() - (oStatus.offsetHeight + oTreeTitle.offsetHeight) + 'px';
		
		var oSettingTitle = getElementsByClassPath(oExplorer, 'Workspace/Setting/TitleBar')[0];
		var oSetting = getElementsByClassPath(oExplorer, 'Workspace/Setting')[0];
		if (oSetting.style.display == 'none') {
			oDocument.style.height = K.get.windowHeight() - 59 + 'px';
		} else {
			oDocument.style.height = K.get.windowHeight() - (oSettingTitle.offsetHeight + oSetting.offsetHeight + oStatus.offsetHeight + 15) + 'px';
		}
	}
	
	K.addEventOnLoad(languageInit);
	K.addEventOnLoad(requestInit);
	K.addEventOnLoad(elementResize);
	K.addEventOnResize(elementResize);
	
	function getDir(currentNode) {
		var connector = eXoPlugin.hostName + eXp.connector + 'getFoldersAndFiles';
		var param = eXp.buildParam(
					"type=" + eXp.resourceType,
					"currentFolder=" + currentNode.title,
					"currentPortal=" + eXoPlugin.portalName,
					buildXParam()
				);
		eXp.sendRequest(connector, param, deployData);
		eXp.store.currentNode = currentNode;
		eXp.store.currentFolder = currentNode.title;
	}
	
	function deployData(iXML) {
		var oExplorer = K('explorer');
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oStatus = K('statusBar');
		var oStatusFile = getElementsByClassPath(oStatus, 'Item')[0];
		var oStatusFolder = getElementsByClassPath(oStatus, 'Folder')[0];
		var oHide = K('hideContainer');
		var currentNode = eXp.store.currentNode;
		var sHTML = '';
		var oFolders = eXp.getNodes(iXML, "Folder");
		if (oFolders && oFolders.length) {
			var iLength = oFolders.length;
			for (var i = 0 ; i < iLength; i++) {
				var sName = eXp.getNodeValue(oFolders[i], "name");
				var sType = eXp.getNodeValue(oFolders[i], "folderType");
					sType = sType.replace(":", "_") + "16x16Icon";
				var sTreeNode = K('hideContainer').select({where: "className == 'TreeNode'"})[0].innerHTML;
				if (i == iLength - 1) sTreeNode = sTreeNode.replace(/\${sClass}/g, 'LastNode');
				else sTreeNode = sTreeNode.replace(/\${sClass}/g, '');
				sTreeNode = sTreeNode.replace(/\${sName}/g, sName);
				sTreeNode = sTreeNode.replace(/\${sType}/g, sType);
				sTreeNode = sTreeNode.replace(/\${sCurrentFolder}/g, currentNode.title);
				sHTML += sTreeNode;
			}
			oStatusFolder.innerHTML = iLength + ' folder(s)';
		} else {
			oStatusFolder.innerHTML = '0 folder(s)';
		}
		var oNodeGroup =  K(currentNode.parentNode.parentNode).select({where: "className == 'NodeGroup'"})[0];
		oNodeGroup.style.display = "block";
		oNodeGroup.innerHTML = sHTML;
		
		
		sHTML = '';
		var oFiles = eXp.getNodes(iXML, "File");
		eXp.store.data = K.create.database({fieldName: ["name", "date", "size", "type", "url"]});
		if (oFiles != null) {
			var oItemGroup = K('checkgen');
			var iLength = oFiles.length;
			if (oItemGroup == null || oItemGroup == '') {
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sURL = eXoPlugin.hostName + '/' + eXp.getNodeValue(oFiles[i], "url");
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					var sHideTreeItem = getElementsByClassPath(oHide, 'HideTreeItem')[0].innerHTML;
					sHideTreeItem = sHideTreeItem.replace(/\${sName}/g, sName);
					sHideTreeItem = sHideTreeItem.replace(/\${sType}/g, sType);
					sHideTreeItem = sHideTreeItem.replace(/\${sDateCreated}/g, sDateCreated.getDate() + '/' + sDateCreated.getMonth() + '/' + sDateCreated.getFullYear() + ' ' + sDateCreated.getHours() + ':' + sDateCreated.getMinutes());
					sHideTreeItem = sHideTreeItem.replace(/\${sURL}/g, sURL);
					sHideTreeItem = sHideTreeItem.replace(/\${sSize}/g, sSize);
					sHTML += '<input type="hidden" id="checkgen">';
					sHTML += sHideTreeItem;
					eXp.store.data.Insert([sName, sDateCreated, sSize, sType, sURL]);
				}
				oDocument.innerHTML += sHTML;
			} else {
				eXp.store.data.Drop();
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					eXp.store.data.Insert([sName, sDateCreated, sSize, sType]);
				} 
				sort('date');
			}
			oStatusFile.innerHTML = iLength + ' files(s)';
		} else {
			eXp.store.data.Drop();
			oDocument.innerHTML = '';
			oStatusFile.innerHTML = '0 files(s)';
		}
	}
	

	</script>
</html>