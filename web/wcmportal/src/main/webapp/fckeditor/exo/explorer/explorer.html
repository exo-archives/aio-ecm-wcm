<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title> eXo File Explorer</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="eXpires" content="0">
		<link type="text/css" rel="stylesheet" href="css/explorer.css">
		<link type="text/css" rel="stylesheet" href="../../../../ecm/skin/icons/16x16/NodeTypes/DefaultStylesheet.css">
		<script type="text/javascript" src="js/explorer.js"></script>
		<script type="text/javascript" src="js/kombai.js"></script>
		<script type="text/javascript">
			var eXoPlugin = window.opener.eXoPlugin;
			eXoPlugin.loadScript(window, "lang/" + eXoPlugin.userLanguage + ".js");
		</script>
	</head>
	<body onclick="hideContextMenu();" oncontextmenu="javascript: return false;">
		<div class="Explorer">
			<div class="FolderNavigation">
				<div class="TitleBar">
					<div class="TitleText" userLanguage="KLang.TreeTitle">
						Folders
					</div>
				</div>
				<div class="Tree">
					<div class="ContextMenu AddNewDocument">
						<a href="javascript: void(0)" class="MenuItem"> 	
							<div class="IconItem IconAdd" onclick="showAddForm(this.id, true)" userLanguage="KLang.CtxNewDoc">
								Add New
							</div>
						</a>
					</div>
				</div>
			</div>
			
			<div class="FolderSeparator"><span></span></div>
			
			<div class="FolderExplorer">
				<div class="MenuBar">
					<a href="javascript: void(0)">
						<div class="Item IconRefresh" style="display: none" userLanguage="KLang.BtnRefresh">Refresh</div>
					</a>
					<a href="javascript: void(0)">
						<div class="Item IconUpload" style="display: none" userLanguage="KLang.BtnUpload">Upload File</div>
					</a>
					<img src="images/IconSeparator2x26.gif" class="IconSeparator" style="display: none">
					<a href="javascript: void(0)">
						<div class="Item IconSetting" onclick="showSetting('Setting')" userLanguage="KLang.BtnSetting">Setting</div>
					</a>
					<a href="javascript: void(0)">
						<div class="Item IconHelp" style="display: none" userLanguage="KLang.BtnHelp">Help</div>
					</a>
					<div style="clear: left;"><span></span></div>
				</div>
				<div class="Setting" style="display: none;">
					<div class="TitleBar" userLanguage="KLang.SettingTitle">Settings</div>
					<div class="SettingDiv">
						<table class="SettingTable" align="center" cellpadding="0" cellspacing="0">
							<tr>
								<td userLanguage="KLang.SetView">View: </td>
								<td userLanguage="KLang.SetSort">Sorting: </td>
							</tr>
							<tr>
							    <td><input type="radio" name="View"><span userLanguage="KLang.ViewThumbnail">Thumbnails</span></td>
								<td><input type="radio" onclick="sort('name')" name="Sort"><span userLanguage="KLang.SortName">By File Name</span></td>
		                    </tr>
							<tr>
							    <td><input type="radio" name="View"><span userLanguage="KLang.ViewList">List</span></td>
								<td><input type="radio" onclick="sort('date')" name="Sort"><span userLanguage="KLang.SortDate">By Date</span></td>
		                    </tr>
							<tr>
							    <td/>
								<td><input type="radio" onclick="sort('size')" name="Sort"><span userLanguage="KLang.Sort_Size">By Size</span></td>
		                    </tr>
						</table>
						<table align="center">
							<tr>
								<td align="center">
									<a href="javascript: void(0)" onclick="showSetting('Setting')">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnClose">
													Close
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
					</div>
				</div>
				
				<div class="DocumentDiv"><span></span></div>	
				<div id="a" class="ContextMenu ListItemOption">
					<a id="b1" href="javascript: void(0)" class="MenuItem"> 	
						<div id="c1" class="IconItem IconView" onclick="window.open(this.id.replace('-view',''),'','width=350,height=250')" userLanguage="KLang.CtxViewItem">
							View
						</div>
					</a>
					<a id="b2" href="javascript: void(0)" class="MenuItem"> 	
						<div id="c2" class="IconItem IconSelect" onclick="alert(this.id.replace('-select',''))" userLanguage="KLang.CtxSelectItem">
							Select
						</div>
					</a>
				</div>
			</div>
		</div>
		<div class="StatusBar">
			<span class="abcFolder"></span>
			<span class="abcItem"></span>
		</div>
		
		<div class="aaaa" id="aaaa">
			<div class="xxxx bbbb" id="bbbb">
				<div class="cccc" id="cccc">
					<div class="dddd" id="dddde">
						<div class="xxxx eeee" onclick="getElementByPath1('aaaa', 'bbbb/cccc/dddd/eeee')" id="xxxx">
							abc
						</div>
					</div>
				</div>
				<div class="bbbb ffff" id="ffff">
					</div>
					<div class="dddd" id="ddddw">
					</div>
					<div class="hhhh" id="hhhh">
					</div>
					<div class="iiii" id="iiii">
					</div>
					<div class="kkkk" id="kkkk">
				</div>
			</div>
		</div>
		
	</body>

	<script type="text/javascript">

	var eXp = {
		connector: eXoPlugin.eXoFileManager.Connector,
		resourceType: eXoPlugin.eXoFileManager.ResourceType,
		command: {
			init: eXoPlugin.command.init || "getFoldersAndFiles",
			getFiles: "getFiles",
			uploadFile: "uploadFile",
			getFolders: "getFolders",
			createFolder: "createFolder"
		},
		buildParam: function() {
			if (arguments.length < 1) return null;
			var arr = [];
			for (var i = 0; i < arguments.length; ++i) {
				arr.push(arguments[i]);
			}
			return arr.join("&");
		},
		getNodes: function(DomX, nodeName) {
			if (!DomX || !nodeName) return null;
			var node = DomX.getElementsByTagName(nodeName);
			if (node.length) return node;
			else return null;
		},
		getSingleNode: function(DomX, nodeName) {
			var nodes = this.getNodes(DomX, nodeName);
			if (nodes[0]) return nodes[0];
			else return null;
		},
		getNodeValue: function(node, name) {
			return node.attributes.getNamedItem(name).value;
		},
		sendRequest: function(connector, param, callback)  {
			K.request({
				address: connector,
				data: param,
				method: "GET",
				onSuccess: function() {
					if (callback && callback instanceof Function) {
						if (this.responseXML) callback(this.responseXML);
						else callback(this.responseText);
					}
				},
				onFailure: function() {
					alert('Can\'t connect to sever. Please try again.');
				}
			});
		}
	}

	function requestInit() {
		var connector = eXoPlugin.hostName + eXp.connector + eXp.command.init;
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=/");
		eXp.sendRequest(connector, param, treeInit);
	}

	function languageInit() {
		//change language
		if (KLang) {
			var aElements = document.getElementsByTagName("*");
			for (var i = 0 ; i < aElements.length; ++i) {
				if (aElements[i].getAttribute && aElements[i].getAttribute("userLanguage")) {
					var userLanguage = eval(aElements[i].getAttribute("userLanguage"));
					var textNode = document.createTextNode(userLanguage);
					aElements[i].innerHTML = "";
					aElements[i].appendChild(textNode);
				}
			}
		}
	};
	
	function elementResize() {
		getElementByClassName('Explorer')[0].style.height = document.documentElement.clientHeight - 20 + 'px';
		// Height of 'FolderNavigationTitleBar': 22px;
		// Border of 'FolderNavigationTitleBar': 1px;
		// Height of 'FolderExplorerStatusBar': 20px;
		// Total: 53px;
		getElementByClassName('Tree').style.height = document.documentElement.clientHeight - 53 + 'px';
		if (getElementByClassName('Setting')[0].style.display == 'none') {
			getElementByClassName('DocumentDiv').style.height = document.documentElement.clientHeight - 59 + 'px';
		}
		else 
			getElementByClassName('DocumentDiv').style.height = document.documentElement.clientHeight - 225 + 'px';
	}
	
	K.addEventOnLoad(languageInit);
	K.addEventOnLoad(requestInit);
	K.addEventOnLoad(elementResize);
	K.addEventOnResize(elementResize);

	function getDir(action, name) {
		var connector = eXoPlugin.hostName + eXp.connector + action;
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=/" + name);
		eXp.sendRequest(connector, param, treeGen);
	}

	function getFile(action, name) {
		var connector = eXoPlugin.hostName + eXp.connector + action;
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=/" + name);
		eXp.sendRequest(connector, param, itemGen);
	}

	// This value is never lost
	var sValue = getElementByClassName('DocumentDiv').innerHTML;
	
	function treeInit(sXML) {
		var sHTML = '';
		
		// Root generate
		sHTML +=
		'<div id="/Document" class="HomeNode" oncontextmenu="showContextMenu(\'AddNewDocument\', event, this)">' +
			'<span>&nbsp;</span>' +
		'</div>' + 
		'<div id="/Documents-gr/" class="NodeGroup">';
		
		// First child generate
		var oFolder = eXp.getNodes(sXML, "Folder");
		
		// If a node have no children, request return null.
		if (oFolder != null) {
			var iLength = oFolder.length;
			for (var i = 0 ; i < iLength; ++i) {
				var sName = eXp.getNodeValue(oFolder[i], "name");
				// By default, noteType = nt:xxxxxx, but css = nt_xxxxxx16x16Icon. So need to replace ':' by '_' and append '16x16Icon'
				var sType = eXp.getNodeValue(oFolder[i], "folderType").replace(':','_') + '16x16Icon';
				sHTML += 
				'<div class="' + (i == oFolder.length - 1 ? 'Node LastNode' : 'Node') + '" style="display: block">' +
					'<div id="/' + sName + '-ec" class="IconExpand">' +
						'<div id="/' + sName + '" class="' + sType + ' IconNode IconClose default16x16Icon" onclick="getDir(\'getFoldersAndFiles\', \'' + sName + '\'); openTree(this);" oncontextmenu="showContextMenu(\'AddNewDocument\', event, this)">' +
							'<a href="javascript: void(0)">' +
								sName +
							'</a>' +
						'</div>' +
					'</div>' +
				'</div>';
			}
			getElementByClassName('abcFolder').innerHTML = iLength + ' folder(s)';
		} else {
			getElementByClassName('abcFolder').innerHTML = '0 folder(s)';
		}
		sHTML += '</div>';
		getElementByClassName('Tree').innerHTML += sHTML;
		
		// Item generate
		
		var oFolder = eXp.getNodes(sXML, "File");

		// If folder has no file
		if (oFolder != null) {
			var iLength = oFolder.length;
			var oItemGroup = getElementByClassName('DocumentTable');
			// If list item is generated
			if (oItemGroup == null || oItemGroup == '') {
				sHTML = '<table class="DocumentTable" align="center" cellpadding="4">';
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFolder[i], "name");
					// By default, noteType = nt:xxxxxx, but css = nt_xxxxxx16x16Icon. So need to replace ':' by '_' and append '16x16Icon'
					var sType = eXp.getNodeValue(oFolder[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFolder[i], "dateCreated"));
					var sURL = eXoPlugin.hostName + '/' + eXp.getNodeValue(oFolder[i], "url");
					var sSize = eXp.getNodeValue(oFolder[i], "size");
					if (sSize == '') {
						sSize = '-';
					}
					sHTML += 
					'<tr>' +
						'<td class="ItemName ' + sType + '">' +
							'<a id="' + sURL + '" href="javascript: void(0)" oncontextmenu="showContextMenu(\'ListItemOption\', event, this)">' + sName + '</a>' +
						'</td>' +
						'<td class="ItemDate">' + sDateCreated + '</td>' +
						'<td class="ItemSize">' + sSize + ' kB</td>' +
					'</tr>';
				}
				sHTML += '</table>';
				getElementByClassName('DocumentDiv').innerHTML += sHTML;
			}
			getElementByClassName('abcItem').innerHTML = iLength + ' item(s)';
		} else {
			getElementByClassName('abcItem').innerHTML = '0 item(s)';
			getElementByClassName('DocumentDiv').innerHTML = sValue;
		}
	}
	
	
	var DB = {};
	function treeGen(sXML) {
		var sHTML;
		
		// Folder generate
		
		// By default, currentFolder = /xxxxxx/, for my tree, it need to replace first and last '/'
		var sCurrentFolder = eXp.getNodeValue(eXp.getSingleNode(sXML, 'CurrentFolder'), 'path');
		sCurrentFolder = sCurrentFolder.substring(1, sCurrentFolder.length - 1);
		
		var oFolder = eXp.getNodes(sXML, "Folder");
			
		// If a node have no children, request return null.
		if (oFolder != null) {
			var iLength = oFolder.length;
			var oNodeGroup = document.getElementById('/' + sCurrentFolder + '-gr/');
			var sTemp = '';
			// If object has requested, it's no need to request again
			if (oNodeGroup == null) {
				sHTML = '<div id="/' + sCurrentFolder + '-gr/" class="NodeGroup">';
				
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFolder[i], "name");
					// By default, noteType = nt:xxxxxx, but css = nt_xxxxxx16x16Icon. So need to replace ':' by '_' and append '16x16Icon'
					var sType = eXp.getNodeValue(oFolder[i], "folderType").replace(':', '_') + '16x16Icon';
					sHTML +=
					'<div class="' + (i == iLength - 1 ? 'Node LastNode' : 'Node') + '" style="display: block">' +
						'<div id="/' + sCurrentFolder + '/' + sName + '-ec" class="IconExpand">' +
							'<div id="/' + sCurrentFolder + '/' + sName + '" class="' + sType + ' IconNode IconClose default16x16Icon " onclick="getDir(\'getFoldersAndFiles\', \'' + sCurrentFolder + '/' + sName + '\'); openTree(this);" oncontextmenu="showContextMenu(\'AddNewDocument\', event, this)">' +
								'<a href="javascript: void(0)">' +
									sName +
								'</a>' +
							'</div>' +
						'</div>' +
					'</div>';
				}
				sHTML += '</div>';
				document.getElementById('/' + sCurrentFolder + '-ec').innerHTML += sHTML;
			}
			getElementByClassName('abcFolder').innerHTML = iLength + ' folder(s)';
		} else {
			getElementByClassName('abcFolder').innerHTML = '0 folder(s)';
		}
		
		// Item generate
		
		var oFolder = eXp.getNodes(sXML, "File");
		// If folder has no file
		if (oFolder != null) {
			DB = K.create.database({
				fieldName: ["name", "date", "size", "type"]
			});
			
			var iLength = oFolder.length;
			var oItemGroup = getElementByClassName('DocumentTable');
			if (oItemGroup == null || oItemGroup == '') {
				sHTML = '<table class="DocumentTable" align="center" cellpadding="4">';
				
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFolder[i], "name");
					// By default, noteType = nt:xxxxxx, but css = nt_xxxxxx16x16Icon. So need to replace ':' by '_' and append '16x16Icon'
					var sType = eXp.getNodeValue(oFolder[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFolder[i], "dateCreated"));
					var sURL = eXoPlugin.hostName + '/' + eXp.getNodeValue(oFolder[i], "url");
					var sSize = eXp.getNodeValue(oFolder[i], "size");
					if (sSize == '') {
						sSize = '-';
					}
					sHTML += 
					'<tr>' +
						'<td class="ItemName ' + sType + '">' +
							'<a id="' + sURL + '" href="javascript: void(0)" oncontextmenu="showContextMenu(\'ListItemOption\', event, this)">' + sName + '</a>' +
						'</td>' +
						'<td class="ItemDate">' + sDateCreated.getDate() + '/' + sDateCreated.getMonth() + '/' + sDateCreated.getFullYear() + ' ' + sDateCreated.getHours() + ':' + sDateCreated.getMinutes() + '</td>' +
						'<td class="ItemSize">' + sSize + ' kB</td>' +
					'</tr>';
					
					DB.Insert([sName, sDateCreated, sSize, sType]);
				}
				sHTML += '</table>';
				getElementByClassName('DocumentDiv').innerHTML += sHTML;
			}
			getElementByClassName('abcItem').innerHTML = iLength + ' item(s)';
		} else {
			getElementByClassName('abcItem').innerHTML = '0 item(s)';
			getElementByClassName('DocumentDiv').innerHTML = sValue;
		}
	}

	function sort(sCondition) {
	
		getElementByClassName('DocumentDiv').innerHTML = sValue;

		var sHTML = '<table class="DocumentTable" align="center" cellpadding="4">';

		var aResult = DB.Select({orderBy: sCondition});
		var iLength = aResult.length;
		for (var i = 0; i < iLength; i++) {
			sHTML += 
				'<tr>' +
					'<td class="ItemName ' + aResult[i].type + '">' +
						'<a href="javascript: void(0)" oncontextmenu="showContextMenu(\'ListItemOption\', event, this)">' + aResult[i].name + '</a>' +
					'</td>' +
					'<td class="ItemDate">' + aResult[i].date.getDate() + '/' + aResult[i].date.getMonth() + '/' + aResult[i].date.getFullYear() + ' ' + aResult[i].date.getHours() + ':' + aResult[i].date.getMinutes() + '</td>' +
					'<td class="ItemSize">' + aResult[i].size + ' kB</td>' +
				'</tr>';
		}
		
		sHTML += '</table>'
		getElementByClassName('DocumentDiv').innerHTML += sHTML;
	}
	
	// Action is executed in: Right click Folder Explorer Navigator -> Choose Add new (bShow = true) or Right click Folder Explorer Navigator -> Choose Add new -> Click Create -> Click Cancel (bShow = false)
	function showAddForm(id, bShow) {
		var idd = id.replace('-add','');
		var sMaxLength = 23;
		var sHTML = 
			'<div class="AddNewDocumentForm">' +
				(idd == '/Document' ? '/' : (idd.length > sMaxLength ? ('...' + idd.substring(idd.length - sMaxLength)) : idd)) + '<p>' +
				'<input id="' + id.replace('-add','-txt') + '" type="text"></p><p>' +
				'<input value="Create" onclick="doAddForm(\'' + idd + '\',document.getElementById(\'' + idd + '-txt\').value)" type="button">' +
				'<input value="Cancel" onclick="showAddForm(\'' + id + '\', false)" userlanguage="KLang.AddFolderCancel" type="button"></p>' +
			'</div>';
		var sMask = '<div class="AddNewDocumentMask"></div>';
		if (bShow) {
			getElementByClassName('Tree').innerHTML += sHTML;	
			document.body.innerHTML += sMask;
		}
		else {
			getElementByClassName('Tree').innerHTML = getElementByClassName('Tree').innerHTML.replace(sHTML, '', 'g');
			document.body.innerHTML = document.body.innerHTML.replace(sMask, '', 'g');
		}
	}
		
	// Action is executed in: Right click Folder Explorer Navigator -> Choose Add new -> Click Create
	function doAddForm(sCurrentFolder, sFolderName) {
		if (sCurrentFolder == '/Document')
			alert('aaaa')
		var connector = eXoPlugin.hostName + eXp.connector + 'createFolder';
		var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=" + (sCurrentFolder == '/Document' ? '' : sCurrentFolder) + "/", "NewFolderName=" + sFolderName);
		eXp.sendRequest(connector, param, function(sXML) {
											var oNodes = eXp.getNodes(sXML, "Error")[0];
											var sErrorNumber = eXp.getNodeValue(oNodes, "number");
											var sErrorText = eXp.getNodeValue(oNodes, "text");
											if (sErrorNumber != '0') {
												alert(sErrorText);
											} else {
												showAddForm(sCurrentFolder + '-add', false);
												// problem when current folder = / or  create 2 folder in same parent
												getDir('getFoldersAndFiles', sCurrentFolder.replace('/','') + '/');
											}
										});
	}
	</script>
</html>