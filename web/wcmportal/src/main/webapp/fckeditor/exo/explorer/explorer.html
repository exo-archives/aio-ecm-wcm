<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title> eXo File Explorer</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="eXpires" content="0">
		<link type="text/css" rel="stylesheet" href="css/explorer.css">
		<link type="text/css" rel="stylesheet" href="../../../../ecm/skin/icons/16x16/NodeTypes/DefaultStylesheet.css">
		<script type="text/javascript" src="js/explorer.js"></script>
		<script type="text/javascript" src="js/kombai.js"></script>
		<script type="text/javascript">
			var FCKConfig = window.opener.FCKConfig;
			var eXoPlugin = window.opener.eXoPlugin;
			eXoPlugin.loadScript(window, "lang/" + eXoPlugin.userLanguage + ".js");
		</script>
	</head>
	<body onclick="hideContextMenu();" oncontextmenu="return false;" scroll="no">
		<div id="root" class="Root" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
			<div id="explorer" class="Explorer">
				<div class="Navigation">
					<div class="MenuBar" userLanguage="KLang.TreeTitle">
						Folders
					</div>
					<div class="Tree"></div>
				</div>
				
				<div class="Separator"><span></span></div>
				
				<div class="Workspace">
					<div class="MenuBar">
						<a href="javascript: void(0);" onclick="showUploadForm(true)">
							<div class="Item IconUpload" userLanguage="KLang.BtnUpload">Upload File</div>
						</a>
						<img src="images/IconSeparator2x26.gif" class="IconSeparator" style="display: none;">
						<a href="javascript: void(0);" onclick="showSetting('Setting')">
							<div class="Item IconSetting" userLanguage="KLang.BtnSetting">Setting</div>
						</a>
						<div style="clear: left;"><span style="display: none;"></span></div>
					</div>
					<div class="Setting" style="display: none;">
						<div class="TitleBar" userLanguage="KLang.SettingTitle">Settings</div>
						<div class="SettingDiv">
							<table class="SettingTable" align="center" cellpadding="0" cellspacing="0">
								<tr>
									<td userLanguage="KLang.SetView">View: </td>
									<td userLanguage="KLang.SetSort">Sorting: </td>
								</tr>
								<tr>
								    <td><input type="radio" name="View"><span userLanguage="KLang.ViewThumbnail">Thumbnails</span></td>
									<td><input type="radio" onclick="sort('name')" name="Sort"><span userLanguage="KLang.SortName">By File Name</span></td>
			                    </tr>
								<tr>
								    <td><input type="radio" name="View"><span userLanguage="KLang.ViewList">List</span></td>
									<td><input type="radio" onclick="sort('date')" name="Sort"><span userLanguage="KLang.SortDate">By Date</span></td>
			                    </tr>
								<tr>
								    <td/>
									<td><input type="radio" onclick="sort('size')" name="Sort"><span userLanguage="KLang.Sort_Size">By Size</span></td>
			                    </tr>
							</table>
							<table align="center">
								<tr>
									<td align="center">
										<a href="javascript: void(0);" onclick="showSetting('Setting')">
											<div class="ButtonLeft">
												<div class="ButtonRight">
													<div class="ButtonMiddle" userLanguage="KLang.BtnClose">
														Close
													</div>
												</div>
											</div>
										</a>
									</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="DisplayArea"><span></span></div>	
				</div>
			</div>
				
			<div id="statusBar" class="StatusBar">
				<span class="Folder"></span>
				<span class="Item"></span>
			</div>
			
			<div id="hideContainer" class="HideContainer" style="display: none;">
				<div class="TreeRoot">
					<div id="/" class="HomeNode">
						<span>&nbsp;</span>
					</div>
					<div id="/group/" class="NodeGroup"></div>
				</div>
				<div class="HideTreeNode">
					<div class="Node ${sClass}" style="display: block">
						<div class="IconExpand">
							<div id="${sCurrentFolder}${sName}" class="${sType} IconNode IconClose default16x16Icon" onclick="getDir('${sCurrentFolder}${sName}'); openTree(this);" oncontextmenu="showContextMenu('AddNewDocument', event, this)">
								<a href="javascript: void(0);">
									${sShortName}
								</a>
							</div>
						</div>
					</div>
				</div>
				<div class="HideTreeItem">
					<table class="DocumentTable" align="center" cellpadding="4">
						<tr>
							<td class="ItemName ${sType}">
								<a id="${sURL}" href="javascript: void(0);" oncontextmenu="showContextMenu('ListItemOption', event, this)">${sName}</a>
							</td>
							<td class="ItemDate">${sDateCreated}</td>
							<td class="ItemSize">${sSize} kB</td>
						</tr>
					</table>
				</div>
				<div class="HideAddForm">
					<div class="AddForm">
						${idShort}
						<input id="${idTxt}" type="text">
						<table align="center">
							<tr>
								<td align="center">
									<a href="javascript: void(0);" onclick="doAddForm('${idOrig}',K('${idTxt}').value)">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnCreate">
													Create
												</div>
											</div>
										</div>
									</a>
								</td>
								<td align="center">
									<a href="javascript: void(0);" onclick="showAddForm('${id}', false)">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnCancel">
													Cancel
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
					</div>
				</div>

				<div id="UploadContainer" style="display: none;">
					<form class="UploadForm" target="iFrameUpload" enctype="multipart/form-data" method="post">
						<table>
							<tr>
								${idShort}
							</tr>
							<tr>
								<td>
									<input type="file" name="file">
								</td>
								<td align="center">
									<a href="javascript: void(0);">
										<div class="ButtonLeft">
											<div class="ButtonRight">
												<div class="ButtonMiddle" userLanguage="KLang.BtnUpload" onclick="uploadFile()">
													Upload
												</div>
											</div>
										</div>
									</a>
								</td>
							</tr>
						</table>
						<iframe name="iFrameUpload" id="iFrameUpload" frameborder="0px" border="0px"></iframe>
					<form>
				</div>
			</div>
		</div>
		<div id="Context" style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px;">	
			<div class="ContextMenu AddNewDocument">
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconAdd" onclick="showAddForm(this.id, true)" userLanguage="KLang.CtxNewDoc">
						Add New
					</div>
				</a>
			</div>
			<div class="ContextMenu ListItemOption">
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconView" onclick="window.open(this.id.replace('/view/',''),'','width=350,height=250')" userLanguage="KLang.CtxViewItem">
						View
					</div>
				</a>
				<a href="javascript: void(0);" class="MenuItem"> 	
					<div class="IconItem IconSelect" onclick="alert(this.id.replace('/select/',''))" userLanguage="KLang.CtxSelectItem">
						Select
					</div>
				</a>
			</div>
		</div>
		<div class="Mask" id="Mask"></div>
		<div class="PopupContainer"  id="PopupContainer">
		</div>
	</body>

	<script type="text/javascript">

	var eXp = {
		resourceType: eXoPlugin.eXoFileManager.ResourceType,
		connector: eXoPlugin.eXoFileManager.Connector,
		command: {
			init: "getFoldersAndFiles",
			uploadFile: "uploadFile/upload",
			controlUpload: "uploadFile/control",
			createFolder: "createFolder"
		},
		store: {
			currentNode: {},
			data: {}
		},
		buildParam: function() {
			if (arguments.length < 1) return null;
			var arr = [];
			for (var i = 0; i < arguments.length; ++i) {
				arr.push(arguments[i]);
			}
			arr.push("language=" + eXoPlugin.userLanguage);
			return arr.join("&");
		},
		getNodes: function(DomX, nodeName) {
			if (!DomX || !nodeName) return null;
			var node = DomX.getElementsByTagName(nodeName);
			if (node.length) return node;
			else return null;
		},
		getSingleNode: function(DomX, nodeName) {
			var nodes = this.getNodes(DomX, nodeName);
			if (nodes[0]) return nodes[0];
			else return null;
		},
		getNodeValue: function(node, name) {
			return node.attributes.getNamedItem(name).value;
		},
		getID: function() {
			return Math.random().toString().substring(2);
		},
		sendRequest: function(connector, param, callback)  {
			K.request({
				address: connector,
				data: param,
				method: "GET",
				onSuccess: function() {
				if (K.check.isFunction(callback)) {
						if (this.responseXML) {
							var response = this.responseXML;
							callback(response);
						} else {
							callback(this.responseText);
						}
					}
				},
				onFailure: function() {
					alert('Can\'t connect to sever. Please try again.');
				}
			});
		}
	}
	
	var curLength = 0;
	var curUploadId = 0;
	
	function buildXParam() {
		var repositoryName = FCKConfig.repositoryName;
		var workspaceName = FCKConfig.workspaceName;
		var jcrPath = FCKConfig.jcrPath;
		var param = '';
		if (repositoryName !== undefined) param += 'repositoryName=' + repositoryName;
		if (workspaceName !== undefined) param += '&workspaceName=' + workspaceName;
		if (jcrPath !== undefined) param += '&jcrPath=' + jcrPath;
		return param;
	}
	
	function requestInit() {
		var connector = eXoPlugin.hostName + eXp.connector + eXp.command.init;
		var param = eXp.buildParam(
					"type=" + eXp.resourceType,
					"currentFolder=/",
					"currentPortal=" + eXoPlugin.portalName,
					buildXParam()
				);
		eXp.sendRequest(connector, param, treeInit);
		eXp.store.currentNode = K('/');
	}

	function languageInit() {
		if (KLang) {
			var aElements = document.getElementsByTagName("*");
			for (var i = 0 ; i < aElements.length; ++i) {
				if (aElements[i].getAttribute && aElements[i].getAttribute("userLanguage")) {
					var userLanguage = eval(aElements[i].getAttribute("userLanguage"));
					var textNode = document.createTextNode(userLanguage);
					aElements[i].innerHTML = "";
					aElements[i].appendChild(textNode);
				}
			}
		} else {
			eXoPlugin.loadScript(window, "lang/en.js");
			setTimeout(languageInit, 2000);
		}
	};
	

	function elementResize() {
		var oExplorer = K("explorer");
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oStatus = K('statusBar');
		oExplorer.style.height = K.get.windowHeight() - oStatus.offsetHeight + 'px';

		var oTreeTitle = getElementsByClassPath(oExplorer, 'Navigation/MenuBar')[0];
		var oTree = getElementsByClassPath(oExplorer, 'Navigation/Tree')[0];
		oTree.style.height = K.get.windowHeight() - (oStatus.offsetHeight + oTreeTitle.offsetHeight) + 'px';
		
		var oSettingTitle = getElementsByClassPath(oExplorer, 'Workspace/Setting/TitleBar')[0];
		var oSetting = getElementsByClassPath(oExplorer, 'Workspace/Setting')[0];
		if (oSetting.style.display == 'none') {
			oDocument.style.height = K.get.windowHeight() - 59 + 'px';
		} else {
			oDocument.style.height = K.get.windowHeight() - (oSettingTitle.offsetHeight + oSetting.offsetHeight + oStatus.offsetHeight + 15) + 'px';
		}
	}
	
	K.addEventOnLoad(languageInit);
	K.addEventOnLoad(requestInit);
	K.addEventOnLoad(elementResize);
	K.addEventOnResize(elementResize);
	
	function getDir(sCurrentFolder) {
		var connector = eXoPlugin.hostName + eXp.connector + 'getFoldersAndFiles';
		var param = eXp.buildParam(
					"type=" + eXp.resourceType,
					"currentFolder=" + sCurrentFolder,
					"currentPortal=" + eXoPlugin.portalName,
					buildXParam()
				);
		eXp.sendRequest(connector, param, treeGen);
		eXp.store.currentNode = K(sCurrentFolder);
	}
	
	function treeInit(sXML) {
		var oExplorer = K('explorer');
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oStatus = K('statusBar');
		var oStatusFolder = getElementsByClassPath(oStatus, 'Folder')[0];
		var oHide = K('hideContainer');
		
		var oTree = getElementsByClassPath(oExplorer, 'Navigation/Tree')[0];
		var oTreeRoot = getElementsByClassPath(oHide, 'TreeRoot')[0];
		oTree.innerHTML += oTreeRoot.innerHTML;
		
		var sHTML = '';
		
		// Folder generator
		var oFolders = eXp.getNodes(sXML, "Folder");
		if (oFolders != null) {
			var iLength = oFolders.length;
			for (var i = 0 ; i < iLength; i++) {
				var sShortName = eXp.getNodeValue(oFolders[i], "name");
				var sName = sShortName + '/';
				var sType = eXp.getNodeValue(oFolders[i], "folderType").replace(':','_') + '16x16Icon';
				var sHideTreeNode = getElementsByClassPath(oHide, 'HideTreeNode')[0].innerHTML;
				if (i == iLength - 1) sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, 'LastNode');
				else sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, '');
				sHideTreeNode = sHideTreeNode.replace(/\${sShortName}/g, sShortName);
				sHideTreeNode = sHideTreeNode.replace(/\${sName}/g, sName);
				sHideTreeNode = sHideTreeNode.replace(/\${sType}/g, sType);
				sHideTreeNode = sHideTreeNode.replace(/\${sCurrentFolder}/g, '/');
				sHideTreeNode = sHideTreeNode.replace('oncontextmenu="showContextMenu(\'AddNewDocument\', event, this)"','');
				sHTML += sHideTreeNode;
			}
			oStatusFolder.innerHTML = iLength + ' folder(s)';
		} else {
			oStatusFolder.innerHTML = '0 folder(s)';
		}
		K('/group/').innerHTML = sHTML;
	}
	
	function treeGen(sXML) {
		var oExplorer = K('explorer');
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oStatus = K('statusBar');
		var oStatusFile = getElementsByClassPath(oStatus, 'Item')[0];
		var oStatusFolder = getElementsByClassPath(oStatus, 'Folder')[0];
		var oHide = K('hideContainer');
		
		var sHTML = '';
		var sCurrentFolder = eXp.store.currentNode.id;
		var oFolders = eXp.getNodes(sXML, "Folder");
		if (oFolders != null) {
			var iLength = oFolders.length;
			var oParent = K(sCurrentFolder).parentNode;
			
			var oNodeGroup = K(sCurrentFolder + 'group/');
			if (oNodeGroup == null) {
				sHTML += '<div id="' + sCurrentFolder + 'group/" class="NodeGroup">';
				for (var i = 0 ; i < iLength; ++i) {
					var sShortName = eXp.getNodeValue(oFolders[i], "name");
					var sName = sShortName + '/';
					var sType = eXp.getNodeValue(oFolders[i], "folderType").replace(':', '_') + '16x16Icon';
					var sHideTreeNode = getElementsByClassPath(oHide, 'HideTreeNode')[0].innerHTML;
					if (i == iLength - 1) sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, 'LastNode');
					else sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, '');
					sHideTreeNode = sHideTreeNode.replace(/\${sShortName}/g, sShortName);
					sHideTreeNode = sHideTreeNode.replace(/\${sName}/g, sName);
					sHideTreeNode = sHideTreeNode.replace(/\${sType}/g, sType);
					sHideTreeNode = sHideTreeNode.replace(/\${sCurrentFolder}/g, sCurrentFolder);
					sHTML += sHideTreeNode;
				}
				sHTML += '</div>'
			} else {
				if (iLength > curLength) {
					//oParent.removeChild(document.getElementById(sCurrentFolder + 'group/'));
					sHTML += '<div id="' + sCurrentFolder + 'group/" class="NodeGroup">';
					for (var i = 0 ; i < iLength; ++i) {
						var sShortName = eXp.getNodeValue(oFolders[i], "name");
						var sName = sShortName + '/';
						var sType = eXp.getNodeValue(oFolders[i], "folderType").replace(':', '_') + '16x16Icon';
						var sHideTreeNode = getElementsByClassPath(oHide, 'HideTreeNode')[0].innerHTML;
						if (i == iLength - 1) sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, 'LastNode');
						else sHideTreeNode = sHideTreeNode.replace(/\${sClass}/g, '');
						sHideTreeNode = sHideTreeNode.replace(/\${sShortName}/g, sShortName);
						sHideTreeNode = sHideTreeNode.replace(/\${sName}/g, sName);
						sHideTreeNode = sHideTreeNode.replace(/\${sType}/g, sType);
						sHideTreeNode = sHideTreeNode.replace(/\${sCurrentFolder}/g, sCurrentFolder);
						sHTML += sHideTreeNode;
					}
					sHTML += '</div>'
				}
			}
			oStatusFolder.innerHTML = iLength + ' folder(s)';
			oParent.innerHTML += sHTML;
			curLength = iLength;
		} else {
			oStatusFolder.innerHTML = '0 folder(s)';
		}
		
		sHTML = '';
		var oFiles = eXp.getNodes(sXML, "File");
		eXp.store.data = K.create.database({fieldName: ["name", "date", "size", "type", "url"]});
		if (oFiles != null) {
			var oItemGroup = K('checkgen');
			var iLength = oFiles.length;
			if (oItemGroup == null || oItemGroup == '') {
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sURL = eXoPlugin.hostName + '/' + eXp.getNodeValue(oFiles[i], "url");
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					var sHideTreeItem = getElementsByClassPath(oHide, 'HideTreeItem')[0].innerHTML;
					sHideTreeItem = sHideTreeItem.replace(/\${sName}/g, sName);
					sHideTreeItem = sHideTreeItem.replace(/\${sType}/g, sType);
					sHideTreeItem = sHideTreeItem.replace(/\${sDateCreated}/g, sDateCreated.getDate() + '/' + sDateCreated.getMonth() + '/' + sDateCreated.getFullYear() + ' ' + sDateCreated.getHours() + ':' + sDateCreated.getMinutes());
					sHideTreeItem = sHideTreeItem.replace(/\${sURL}/g, sURL);
					sHideTreeItem = sHideTreeItem.replace(/\${sSize}/g, sSize);
					sHTML += '<input type="hidden" id="checkgen">'
					sHTML += sHideTreeItem;
					eXp.store.data.Insert([sName, sDateCreated, sSize, sType, sURL]);
				}
				oDocument.innerHTML += sHTML;
			} else {
				eXp.store.data.Drop();
				for (var i = 0 ; i < iLength; ++i) {
					var sName = eXp.getNodeValue(oFiles[i], "name");
					var sType = eXp.getNodeValue(oFiles[i], "fileType").replace(':', '_') + '16x16Icon';
					var sDateCreated = dateFormat(eXp.getNodeValue(oFiles[i], "dateCreated"));
					var sSize = eXp.getNodeValue(oFiles[i], "size");
					if (sSize == '') sSize = '-';
					eXp.store.data.Insert([sName, sDateCreated, sSize, sType]);
				} 
				sort('date');
			}
			oStatusFile.innerHTML = iLength + ' files(s)';
		} else {
			eXp.store.data.Drop();
			oDocument.innerHTML = '';
			oStatusFile.innerHTML = '0 files(s)';
		}
	}
	
	function sort(sCondition) {
		var oExplorer = K('explorer');
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oHide = K('hideContainer');
		
		oDocument.innerHTML = '';
		var sHTML = '';
		var aResult = eXp.store.data.Select({orderBy: sCondition});
		var iLength = aResult.length;
		for (var i = 0; i < iLength; i++) {
			var HideTreeItem = getElementsByClassPath(oHide, 'HideTreeItem')[0].innerHTML;
			HideTreeItem = HideTreeItem.replace(/\${sName}/g, aResult[i].name);
			HideTreeItem = HideTreeItem.replace(/\${sType}/g, aResult[i].type);
			HideTreeItem = HideTreeItem.replace(/\${sDateCreated}/g, aResult[i].date.getDate() + '/' + aResult[i].date.getMonth() + '/' + aResult[i].date.getFullYear() + ' ' + aResult[i].date.getHours() + ':' + aResult[i].date.getMinutes());
			HideTreeItem = HideTreeItem.replace(/\${sURL}/g, aResult[i].url);
			HideTreeItem = HideTreeItem.replace(/\${sSize}/g,  aResult[i].size);
			sHTML += '<input type="hidden" id="checkgen">';
			sHTML += HideTreeItem;
		}
		oDocument.innerHTML += sHTML;
	}
	
	function showAddForm(id, show) {
		var oExplorer = K('explorer');
		var oDocument = getElementsByClassPath(oExplorer, 'Workspace/DisplayArea')[0];
		var oHide = K('hideContainer');
		var idOrig = id.replace('add/','');
		var sMaxLength = 23;
		var idShort = (idOrig == '/' ? '/' : (idOrig.length > sMaxLength ? ('... ' + idOrig.substring(idOrig.length - sMaxLength)) : idOrig))
		var idTxt = id.replace('add/','txt/');
		
		var sHideAddForm = getElementsByClassPath(oHide, 'HideAddForm')[0].innerHTML;
		sHideAddForm = sHideAddForm.replace(/\${idOrig}/g, idOrig);
		sHideAddForm = sHideAddForm.replace(/\${idShort}/g, idShort);
		sHideAddForm = sHideAddForm.replace(/\${idTxt}/g, idTxt);
		sHideAddForm = sHideAddForm.replace(/\${id}/g, id);
		
		if (show) {
			oExplorer.innerHTML += sHideAddForm;
			oExplorer.innerHTML += oHideMask.innerHTML;
		} else {
			oExplorer.innerHTML = oExplorer.innerHTML.replace(sHideAddForm, '');
			oExplorer.innerHTML = oExplorer.innerHTML.replace(oHideMask.innerHTML, '', 'g');
		}
	}
		
	function doAddForm(sCurrentFolder, sFolderName) {
		var connector = eXoPlugin.hostName + eXp.connector + 'createFolder';
		var param = eXp.buildParam(
					"type=" + eXp.resourceType,
					"currentFolder=" + sCurrentFolder,
					"newFolderName=" + sFolderName,
					"currentPortal=" + eXoPlugin.portalName
				);
		eXp.sendRequest(
			connector,
			param,
			function(sXML) {
				var oNodes = eXp.getNodes(sXML, "Error")[0];
				var sErrorNumber = eXp.getNodeValue(oNodes, "number");
				var sErrorText = eXp.getNodeValue(oNodes, "text");
				if (sErrorNumber != '0') {
					alert(sErrorText);
				} else {
					showAddForm(sCurrentFolder + 'add/', false);
					getDir(sCurrentFolder);
				}
			}
		);
	}
	
	function showUploadForm(show) {
		var uploadContainer = K("UploadContainer");
		var popupContainer = K("PopupContainer");
		popupContainer.style.display = "block";
		popupContainer.innerHTML = uploadContainer.innerHTML;
		var mask = K("Mask");
		mask.style.display = "block";
	}
	
	function uploadFile() {
		var popupContainer = K("PopupContainer");
		var formUpload = K.select({from: popupContainer, where: "nodeName == 'FORM'"})[0];
		formUpload.id =  eXp.getID();
		var param = eXp.buildParam("uploadId=" + formUpload.id, "currentFolder=/", buildXParam());
		if (formUpload) {
			formUpload.action = eXp.connector + eXp.command.uploadFile + "?" + param;
			formUpload.submit();
			
		}
		eXp.stopUpload = false;
		K.set.timeout({
			until: function() {return eXp.stopUpload;},
			amount: 3,
			method: function() {
				var connector = eXp.connector + eXp.command.controlUpload;
				var param = eXp.buildParam("action=progress", "uploadId=" + formUpload.id, "currentFolder=/", buildXParam());
				eXp.sendRequest(connector, param, function(iXML) {alert(iXML)});
			}
		});
	}
	</script>
</html>