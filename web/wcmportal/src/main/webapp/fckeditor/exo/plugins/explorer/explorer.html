<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><title>eXplorer</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="eXpires" content="0">
	<script type="text/javascript" src="js/kombai.js"></script>
	<style type="text/css">
		A {
			text-decoration: none;
		}
	</style>
</head>
<body>
 <div style="padding: 6px; background: #effffe" id="result"></div>
</body>
<script type="text/javascript">
var eXoPlugin = window.opener.eXoPlugin;
var eXp = {
	connector: eXoPlugin.eXoFileManager.Connector,
	resourceType: eXoPlugin.eXoFileManager.ResourceType,
	command: {
		getFiles: "getFiles",
		uploadFile: "uploadFile",
		getFolders: "getFolders",
		createFolder: "createFolder"
	},
	buildParam: function() {
		if (arguments.length < 1) return null;
		var arr = [];
		for (var i = 0; i < arguments.length; ++i) {
			arr.push(arguments[i]);
		}
		return arr.join("&");
	},
	getNodes: function(DomX, nodeName) {
		if (!DomX || !nodeName) return null;
		var node = K.select({from: DomX, where: "nodeName == '" + nodeName + "'"});
		if (node.length) return node;
		else return null;
	},
	getSingleNode: function(DomX, nodeName) {
		var nodes = this.getNodes(DomX, nodeName);
		if (nodes[0]) return nodes[0];
		else return null;
	},
	getNodeValue: function(node, name) {
		return node.attributes.getNamedItem(name).value;
	},
	sendRequest: function(connector, param, callback)  {
		K.request({
			address: connector,
			data: param,
			method: "GET",
			onSuccess: function() {
				if (callback && callback instanceof Function) {
					if (this.responseXML) callback(this.responseXML);
					else callback(this.responseText);
				}
			},
			onFailure: function() {
				alert('Can"t connect to sever. Please try again.');
			}
		});
	}
}



window.onload = function () {
	var connector = eXoPlugin.hostName + eXp.connector + eXp.command.getFolders;
	var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=/");
	eXp.sendRequest(connector, param, show);
}

function createNode(refer, name) {
	var sHtml =  '<div style="cursor: pointer"  ><b>' + name + ' : </b>';
		sHtml += '<a href="javascript: void(0);" onclick="getDir(\'getFoldersAndFiles\', \'' + refer + name + '\');"> getFoldersAndFiles </a>';
		sHtml += ' | ';
		sHtml += '<a href="javascript: void(0);" onclick="getDir(\'' + eXp.command.getFolders + '\', \'' + refer + name + '\');"> getFolders </a>';
		sHtml += ' | ';
		sHtml += '<a href="javascript: void(0);" onclick="getDir(\'' + eXp.command.getFiles + '\', \'' + refer + name + '\');"> getFiles </a>';
		sHtml += '</div>';
	return sHtml;
}

function getDir(action, name) {
	var connector = eXoPlugin.hostName + eXp.connector + action;
	var param = eXp.buildParam("Type=" + eXp.resourceType , "CurrentFolder=" + name + "/");
	eXp.sendRequest(connector, param, show);
}

function show(iXML) {
	var dir = eXp.getNodes(iXML, "Folder");
	if (!dir) return;
	var cur = eXp.getNodeValue(eXp.getSingleNode(iXML, "CurrentFolder"), "path");
	var sHtml = "<div>Current Folder : <span style='color: red'>" + cur + "</span></div>";
	for (var i = 0 ; i < dir.length; ++i) {
		var name = eXp.getNodeValue(dir[i], "name");
		sHtml += createNode(cur, name);
	}
	var Result = K.create.element({tagName: "div", innerHTML: sHtml});
	var Hr = K.create.element({tagName: "div"});
	var result = document.getElementById("result");
	Hr.style.borderTop = "1px solid orange";
	Hr.style.marginBottom = "20px";
	K.insert({element: Hr, refer: result});
	K.insert({element: Result, refer: result});
}
</script>
</html>
